<!-- Search Page -->

<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <div class="navbar-header" ng-include="'app-navbar-header.html'"></div>

        <form class="navbar-form navbar-right" role="search" style="width:75%;">
            <div class="form-group input-group" style="width:100%;">
                <!-- type dropdown -->
                <div class="input-group-btn dropdown" style="width:1%;" ng-if="search.types">
                    <button type="button" class="btn dropdown-toggle"
                        ng-class="{
                            'btn-default': !search.params.t,
                            'btn-info'   :  search.params.t
                        }" aria-haspopup="true" aria-expanded="false">
                        {{search.params.t ? "In " + search.params.t : "All"}}
                        <span class="caret"></span></button>
                    <ul class="dropdown-menu">
                        <li><a ng-click="search.params.t = null; search.doSearch()">All</a></li>
                        <li role="separator" class="divider"></li>
                        <li ng-repeat="ty in search.types"><a ng-click="search.params.t = ty; search.doSearch()">{{ty}}</a></li>
                    </ul>
                </div>
                <!-- search box -->
                <input type="search" class="form-control"
                    placeholder="Search keywords, field:/regex/, ..."
                    ng-model="search.params.q">
                <!-- search button -->
                <span class="input-group-btn" style="width:1%;">
                    <button type="submit" class="btn btn-primary" ng-click="search.doSearch()">
                        <i class="fa fa-search"></i><span class="sr-only"> Search</span></button>
                </span>
            </div>
        </form>
    </div>
</nav>
<style>body { padding-top: 70px; }</style>


<!-- Search results -->
<div class="container-fluid">
    <div class="row">
        <div class="col-xs-2 affix sidebar">
            <!-- faceted search with aggregations -->
            <div ng-repeat="(field, agg) in search.results.aggregations">
                <h4>{{field}}</h4>
                <table ng-init="fieldType = search.getFieldType(field)">
                    <tr ng-repeat="bucket in agg.buckets track by $index">
                        <td><button class="btn btn-default btn-xs" ng-click="search.doNavigate(field, bucket.key)">{{bucket.key}}</button></td>
                        <td class="text-right"><span class="badge badge-default">{{bucket.doc_count}}</span></td>
                    </tr>
                    <tr ng-if="fieldType != 'string' && search.results.hits.total > search.countTotalDocCountOfBuckets(agg)">
                        <td><button class="btn btn-default btn-xs" ng-click="search.doNavigate(field, null)"><em>null</em></button></td>
                        <td class="text-right"><span class="badge badge-default">{{search.results.hits.total - search.countTotalDocCountOfBuckets(agg)}}</span></td>
                    </tr>
                </table>
            </div>

        </div>
        <div class="col-xs-10 col-xs-offset-2 main">
            <div class="pull-right">
	        <button type="button" class="btn btn-default"
	            ng-click='openModal({templateUrl:"search/search-debug-modal.html", size:"lg"})'
	            data-toggle="modal" data-target="#search-debug-modal"><i class="fa fa-cogs"></i></button>
	    </div>

            <!-- error and progress boxes -->
            <div class="alert alert-danger" ng-if="search.error">
                <p class="lead">Error: {{search.error.message}}</p>
                <p ng-bind-html="search.error.body"></p>
            </div>
            <div ng-if="search.queryRunning">
                <p class="lead">Searching <span ng-init="query = search.queryRunning" ng-include="'search/search-query.html'"></span></p>
                <p>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:100%;">
                            <span class="sr-only">In Progress</span>
                        </div>
                    </div>
                </p>
            </div>

            <div ng-if="!search.queryRunning">
                <!-- search results summary -->
                <p class="lead">
                    <span ng-if="! search.results.hits.total > 0">No results</span>
                    <span ng-if="search.results.hits.total > 0">
                        {{
                            search.query.body.from + 1                               | number
                        }}-{{
                            search.query.body.from + search.results.hits.hits.length | number
                        }} of {{search.results.hits.total | number}} results
                    </span>
                    <span ng-init="query = search.query" ng-include="'search/search-query.html'"></span>
                    <script type="text/ng-template" id="search/search-query.html">
                        for
                        <span ng-if="query.body.query.query_string.query">
                            [ <strong>{{query.body.query.query_string.query}}</strong> ]
                        </span>
                        <span ng-if="!query.body.query.query_string.query">everything</span>
                        <span ng-if="query.type"> in <em>{{query.type}}</em></span>
                    </script>
                </p>

                <!-- individual search results -->
                <ol start="{{search.query.body.from + 1}}">
                    <li ng-repeat="hit in search.results.hits.hits track by $index" class="hit">
                        <!-- provenance hyperlink -->
                        <p>
                            <!-- TODO routing param -->
                            <a href="api/elasticsearch/{{hit._index | urlEncode}}/{{hit._type | urlEncode}}/{{hit._id | urlEncode}}"
                               class="text-muted">{{hit._type}}( {{hit._id}} ) in {{hit._index}}</a>
                        </p>

                        <!-- highlights, visualization -->
                        <blockquote>
                            <dl ng-if=" hit.highlight">
                                <dt ng-repeat-start="(field, highlight) in hit.highlight">{{field}}</dt>
                                <dd ng-repeat-end>
                                    <span ng-repeat="h in highlight" ng-bind-html="h"></span>
                                </dd>
                            </dl>
                            <span ng-if="!hit.highlight">
                                <dl ng-if=" search.fieldsSearchable">
                                    <dt ng-repeat-start="field in search.fieldsSearchable" ng-if="hit._source[field] != null">{{field}}</dt>
                                    <dd ng-repeat-end ng-if="hit._source[field] != null">
                                        <!-- TODO field may be paths with dots -->
                                        <span>{{hit._source[field]}}</span>
                                    </dd>
                                </dl>
                                <span ng-if="!search.fieldsSearchable">{{hit._source | json | limitTo:500}}</span>
                            </span>

                            <!-- TODO use more sophisticated per-type presentation templates -->

                            <!-- raw _source document data -->
                            <div ng-hide="showJsonTree"><tt>{<span ng-click="showJsonTree = 1" style="cursor:pointer;">...</span>}</tt></div>
                            <div ng-if="showJsonTree">
                                <json-tree json="hit" edit-level="readonly" collapsed-level="2"></json-tree>
                            </div>
                        </blockquote>
                    </li>
                </ol>
            </div>

            <!-- debug info in a modal -->
            <script type="text/ng-template" id="search/search-debug-modal.html">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="searchDebugModalLabel">Search Debug Info</h4>
                </div>
                <div class="modal-body">

                    <h3>query</h3>
                    <json-tree json="search.query" edit-level="readonly" collapsed-level="4"></json-tree>

                    <h3>results</h3>
                    <json-tree json="search.results" edit-level="readonly" collapsed-level="3"></json-tree>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" ng-click="$dismiss()">Close</button>
                </div>
            </script>
        </div>
    </div>
</div>
<style>
.sidebar {
    top: 70px;
    bottom: 90px;
    overflow-y: auto; 
}

.hit blockquote .hlt1 { background-color: #ffc; }
.hit blockquote .hlt2 { background-color: #cff; }
.hit blockquote .hlt3 { background-color: #fcf; }
.hit blockquote .hlt4 { background-color: #ccf; }
.hit blockquote .hlt5 { background-color: #cfc; }
.hit blockquote .hlt6 { background-color: #fcc; }

[ng-hide=showJsonTree] {
    font-size: 13px;
    font-family: monospace;
}
</style>


<nav class="navbar navbar-default navbar-fixed-bottom">
    <div class="container">
        <div class="text-center">
            <pagination class="pagination-sm fa"
            total-items="search.results.hits.total" items-per-page="search.params.n"
            ng-model="search.params.p"
            ng-model-options="{ debounce: 200 }"
            previous-text="&#xf04a;" next-text="&#xf04e;" first-text="&#xf049;" last-text="&#xf050;"
            max-size="9" boundary-links="true"></pagination>
        </div>
    </div>
</nav>
<style>body { padding-bottom: 70px; }</style>
