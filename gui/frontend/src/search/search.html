  <script type="text/javascript">
    
    function parse_query(query_text) {
      require(['/ext/qp/lucene-query-parser.js'], function(parser) {
        var results = parser.parse(query_text);
        console.log(results)
        return results
      });
    }
    //parse_query('A AND (B OR hey:bbb)');
    window.parse_query = parse_query;    

  </script>



<!-- Search Page -->

    <script type="text/ng-template" id="labelPopoverTemplate.html">
      <div class="feedback-box">
        <div>Does this indicate <em>{{extractor}}</em>?</div>
        <div class="btn-group">
          <label uib-btn-radio="'correct'" ng-model="tag.is_correct" ng-click="commit(tag.is_correct)" class="btn" ng-class="tag.is_correct == 'correct'? 'btn-success' : 'btn-default'"><i class="fa fa-check"></i></label>
          <label uib-btn-radio="'incorrect'" ng-model="tag.is_correct" ng-click="commit(tag.is_correct)" class="btn" ng-class="tag.is_correct == 'incorrect'? 'btn-danger' : 'btn-default'"><i class="fa fa-remove"></i></label>
          <label uib-btn-radio="'unknown'" ng-model="tag.is_correct" ng-click="commit(tag.is_correct)" class="btn" ng-class="tag.is_correct == 'unknown'? 'btn-warning' : 'btn-default'"><i class="fa fa-question-circle"></i></label>
        </div>
        <div ng-if="last_user_name && last_user_name !== ''" style="color:#999999">
          reported by {{last_user_name}}
        </div>
      </div>
    </script>

    <script type="text/ng-template" id="annotationPopoverTemplate.html">
      <div class="feedback-box">
        <div>This indicates:</div>
            <input type="text" data-role="tagsinput" add="add" remove="remove"
                tags="annotation.tags" tagsinput-custom-events  />
        <div ng-if="annotation.tags.length">
          <div>Comment (optional):</div>
          <textarea type="text" ng-model="annotation.comment" ng-trim="true" 
            style="white-space:pre-wrap;resize:none" class="form-control" 
            ng-blur="onCommentBlur()" ng-change="onCommentChange()"></textarea>
        </div>
        <div ng-if="annotation.user_name && annotation.user_name !== ''" style="color:#999999">
          reported by {{annotation.user_name}}
        </div>
        </div>
      </div>
    </script>

    <script type="text/ng-template" id="helpVideo.html">
       <div style="overflow:hidden;background-color:white">
         <video width="800" height="500" controls autoplay style="background-color:white !important;display:block">
           <source src="search/template/__VIDEO__.MP4" type="video/mp4" /><!-- WebKit video    -->
         </video>
       </div>
    </script>

<!-- Flag descriptions -->

<script type="text/ng-template" id="flagHelpTraveling.html">
  <div ng-click="close($event)">
    <b>Traveling</b><br>
    From <span class="label label-info">ads</span> &mdash; Likely indications that the provider is traveling between places.
  </div>
</script>

<script type="text/ng-template" id="flagHelpOrganized.html">
  <div ng-click="close($event)">
    <b>Organized</b><br>
    From <span class="label label-info">ads</span> and <span class="label label-success">reviews</span> &mdash; Likely indications that an agency / pimp / handler or multiple providers are involved.
  </div>
</script>

<script type="text/ng-template" id="flagHelpCompletion.html">
  <div ng-click="close($event)">
    <b>Completion</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications that the john completed his business.
  </div>
</script>

<script type="text/ng-template" id="flagHelpBad%20Experience.html">
  <div ng-click="close($event)">
    <b>Bad Experience</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications that the john (author) was complaining about a bad experience.
  </div>
</script>

<script type="text/ng-template" id="flagHelpLE%20Cautious.html">
  <div ng-click="close($event)">
    <b>LE Cautious</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications that the provider was cautious of law enforcement officers pretending to be customers.
  </div>
</script>

<script type="text/ng-template" id="flagHelpNew%20to%20Biz.html">
  <div ng-click="close($event)">
    <b>New to Biz</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications that the provider was new to the business.    
  </div>
</script>

<script type="text/ng-template" id="flagHelpFake%20Photo.html">
  <div ng-click="close($event)">
    <b>Fake Photo</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications that the provider used a fake photo in ads.
  </div>
</script>

<script type="text/ng-template" id="flagHelpPoor%20English.html">
  <div ng-click="close($event)">
    <b>Poor English</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications that the provider did not speak English well.
  </div>
</script>

<script type="text/ng-template" id="flagHelpUnderage.html">
  <div ng-click="close($event)">
    <b>Underage</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications that the provider was plausibly underage (e.g.,descriptions like "very young" and "barely legal").
  </div>
</script>

<script type="text/ng-template" id="flagHelpJuvenile.html">
  <div ng-click="close($event)">
    <b>Juvenile</b><br>
    From <span class="label label-info">ads</span> and <span class="label label-success">reviews</span> &mdash; Likely indications that the provider was plausibly juvenile (e.g., stated age is 20 or younger, or review contains descriptions like "very young" and "barely legal").
  </div>
</script>

<script type="text/ng-template" id="flagHelpEducated.html">
  <div ng-click="close($event)">
    <b>Educated</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications that the provider was educated (e.g., attending college).
  </div>
</script>

<script type="text/ng-template" id="flagHelpDrug%20Use.html">
  <div ng-click="close($event)">
    <b>Drug Use</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications of signs for drug use either prior to or during the transaction.
  </div>
</script>

<script type="text/ng-template" id="flagHelpCoercion.html">
  <div ng-click="close($event)">
    <b>Coercion</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications that the provider was under pressure from a third party (e.g., signs of unwillingness).
  </div>
</script>

<script type="text/ng-template" id="flagHelpPhysical%20Abuse.html">
  <div ng-click="close($event)">
    <b>Physical Abuse</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications that the provider was physically abused (e.g., mentions of scars or bruises).
  </div>
</script>

<script type="text/ng-template" id="flagHelpTheft%20%2F%20Robbery.html">
  <div ng-click="close($event)">
    <b>Theft / Robbery</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications that the johnâ€™s money or property was taken without consent.
  </div>
</script>

<script type="text/ng-template" id="flagHelpIncompletion.html">
  <div ng-click="close($event)">
    <b>Incompletion</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications that the john stopped short of completing the business.
  </div>
</script>

<script type="text/ng-template" id="flagHelpArmed%20%26%20Dangerous.html">
  <div ng-click="close($event)">
    <b>Armed &amp; Dangerous</b><br>
    From <span class="label label-success">reviews</span> &mdash; Likely indications that the provider or associates were armed and/or could be potentially violent.
  </div>
</script>

<script type="text/ng-template" id="flagHelpForeign%20Providers.html">
  <div ng-click="close($event)">
    <b>Foreign Providers</b><br>
    From <span class="label label-info">ads</span> &mdash; Likely indications that the provider came from a foreign country. Signals include ethnicity mentions and phrases like "exotic girls from Russia."
  </div>
</script>

<script type="text/ng-template" id="flagHelpRisky%20Services.html">
  <div ng-click="close($event)">
    <b>Risky Services</b><br>
    From <span class="label label-info">ads</span> &mdash; Likely indications of the provider offering risky sexual services.
  </div>
</script>

<script type="text/ng-template" id="flagHelpDerogatory%20Descriptions.html">
  <div ng-click="close($event)">
    <b>Derogatory Descriptions</b><br>
    From <span class="label label-info">ads</span> &mdash; Likely indications of derogatory descriptions of the provider.
  </div>
</script>

<script type="text/ng-template" id="flagHelpPorn%20%2F%20Cam%20Services.html">
  <div ng-click="close($event)">
    <b>Porn / Cam Services</b><br>
    From <span class="label label-info">ads</span> &mdash; Likely indications of porn or webcam services offered in the ad.
  </div>
</script>

<script type="text/ng-template" id="flagHelpHotel.html">
  <div ng-click="close($event)">
    <b>Hotel</b><br>
    From <span class="label label-info">ads</span> &mdash; Likely indications that the ad offers service in a hotel.
  </div>
</script>

<script type="text/ng-template" id="flagHelpAgency.html">
  <div ng-click="close($event)">
    <b>Agency</b><br>
    From <span class="label label-info">ads</span> &mdash; Likely indications that the ad is posted by an agency.
  </div>
</script>

<script type="text/ng-template" id="flagHelpURL%20Embedding.html">
  <div ng-click="close($event)">
    <b>URL Embedding</b><br>
    From <span class="label label-info">ads</span> &mdash; Links to external websites are embedded in the ads.
  </div>
</script>

<script type="text/ng-template" id="flagHelpMultiple%20Girls.html">
  <div ng-click="close($event)">
    <b>Multiple Girls</b><br>
    From <span class="label label-info">ads</span> &mdash; Likely indications that multiple girls are advertised.
  </div>
</script>

<script type="text/ng-template" id="flagHelpMassage%20Parlor.html">
  <div ng-click="close($event)">
    <b>Massage Parlor</b><br>
    From <span class="label label-info">ads</span> &mdash; Likely indications that services are offered in a massage parlor.
  </div>
</script>

<script type="text/ng-template" id="flagHelpAccepts%20Credit%20Cards.html">
  <div ng-click="close($event)">
    <b>Accepts Credit Cards</b><br>
    From <span class="label label-info">ads</span> &mdash; Likely indications that credit cards are accepted for payment.
  </div>
</script>

<script type="text/ng-template" id="flagHelpMissing.html">
  <div ng-click="close($event)">
    <b>Missing description</b><br>
    No description for this flag.
  </div>
</script>


<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header" ng-include="'app-navbar-header.html'"></div>
        <div sign-in-out-menu style="float:right;height:50px;width:50px;margin-left:30px;"></div>
        <div class="pull-right" style="text-align:center;color:#999999;margin-left:30px;padding-top:10px;font-size:11px">
                <div help-video style="cursor:pointer">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-television fa-stack-2x" style="padding-top:3px"></i>
                    <i class="fa fa-question fa-stack-1x"></i>
                  </span>
                </div>
        </div>

        <div deepdive-search-bar for="search"></div>
    </div>
</nav>
<style>body { padding-top: 70px; }</style>


<!-- Search results -->
<div>
    <div class="row">
        <div class="col-xs-2 col-md-3 affix sidebar">
            <!-- faceted search with aggregations -->
            <div ng-repeat="agg in search.results.facets" ng-if="agg.buckets.length > 0" ng-init="field=agg.field">
                <h4 data-toggle="collapse" data-target="#facets-{{field | safeId}}"
                    aria-expanded="true" aria-controls="facets-{{field | safeId}}"
                    class='facet-header'
                    ng-click="search.toggleFacetCollpase(field)">
                    <i class="fa" ng-class="agg.collapsed ? 'fa-plus-square-o' : 'fa-minus-square-o'"></i>&nbsp;
                    {{field}}
                    <small class="muted">({{agg.count | number}})</small>
                </h4>
                <div id="facets-{{field | safeId}}" class="collapse" ng-class="agg.collapsed ? '' : 'in'">
                <div class="row" ng-if="agg.is_range" style="margin-bottom:8px" data-field="{{field}}">
                    <div class="col-sm-4">
                        <input type='text' placeholder='Min' class="form-control input-sm min-box" my-date-picker ng-if="agg.is_date">
                        <input type='text' placeholder='Min' class="form-control input-sm min-box" ng-if="!agg.is_date">
                    </div>
                    <div class="col-sm-4">
                        <input type='text' placeholder='Max' class="form-control input-sm max-box" my-date-picker ng-if="agg.is_date">
                        <input type='text' placeholder='Max' class="form-control input-sm max-box" ng-if="!agg.is_date">
                    </div>
                    <div class="col-sm-1"><button type="button" class="btn btn-default btn-small input-sm minmax-go">Go</button></div>
                </div>
                <table ng-if="field !== 'images'" class="table table-hover table-condensed"
                    ng-init="fieldType = search.getFieldType(field)">
                    <!--<tr ng-repeat="bucket in agg.buckets track by $index" ng-click="search.doNavigate($event, field, bucket.key)">-->
                    <tr ng-repeat="bucket in agg.buckets track by $index" ng-click="search.doNavigate($event, field, bucket.key)">
                        <td>
                            <a ng-if="field == 'domain_type'" class="label"
                                style="cursor: pointer"
                                ng-class="bucket.key == 'ads' ? 'label-info' : 'label-success'">
                                {{bucket.key}}
                            </a>
                            <a ng-if="field !== 'domain_type'"
                                style="cursor: pointer"
                                ng-class="{ 'label': field == 'flags' || field == 'annotated_flags', 'label-warning': field == 'flags', 'label-annotation' : field == 'annotated_flags'}">
                                {{bucket.key}}
                            </a>
                            <span ng-if="field == 'flags'">&nbsp;
                               <span ng-if="search.flag_infos[bucket.key]['ads']" class="label label-info label-hover"
                                  ng-click="search.doNavigateMultiple($event, { 'flags' : bucket.key, 'domain_type':'ads' }, true);
                                            $event.stopPropagation()"
                                            uib-tooltip="New search on ads only." tooltip-placement="top">ads</span>
                               <span ng-if="search.flag_infos[bucket.key]['reviews']" class="label label-success label-hover"
                                  ng-click="search.doNavigateMultiple($event, { 'flags' : bucket.key, 'domain_type':'reviews' }, true); $event.stopPropagation()" uib-tooltip="New search on reviews only." tooltip-placement="top">reviews</span>
                            </span>
                            <a ng-if="bucket.key == ''"><em>(empty)</em></a>
                            <span ng-if="field == 'flags' || field == 'annotated_flags' && tags.flags && tags.flags[bucket.key]" flag-help key="{{bucket.key}}"></span>
                            <span ng-if="field == 'annotated_flags' && tags.flags && !tags.flags[bucket.key]" class="label label-default" style="margin-left:5px">new</span>
                        </td>
                        <td class="text-right"><span class="badge badge-default">{{bucket.doc_count | number}}</span></td>
                    </tr>
                    <tr ng-if="fieldType != 'string' && search.results.hits.total > search.countTotalDocCountOfBuckets(agg)">
                        <td><a><em>null</em></a></td>
                        <td class="text-right"><span class="badge badge-default">{{search.results.hits.total - search.countTotalDocCountOfBuckets(agg)}}</span></td>
                    </tr>
                </table>
                <div ng-if="field === 'images'" style="display:block">
                  <div style="cursor:pointer;display:inline-block;position:relative;" ng-repeat="bucket in agg.buckets track by $index" ng-click="search.doNavigate($event, field, bucket.key)">
                    <img class="lazy image-blur" ng-src="https://s3.amazonaws.com/roxyimages/{{bucket.key}}.jpg" style="max-height:50px;border:0px" />
                    <div style="position:absolute;bottom:2px;right:2px">
                      <span class="badge badge-default">~{{bucket.doc_count | number}}</span>
                    </div>
                  </div>
                </div>
                </div>
            </div>

        </div>
        <div class="col-xs-10 col-xs-offset-2 col-md-9 col-md-offset-3 main">
            <div class="pull-right">
            <button type="button" class="btn btn-default hide"
                ng-click='openModal({templateUrl:"search/search-debug-modal.html", size:"lg"})'
                data-toggle="modal" data-target="#search-debug-modal"><i class="fa fa-cogs"></i></button>
        </div>

            <!-- error and progress boxes -->
            <div class="alert alert-danger" ng-if="search.error">
                <p class="lead">Error: {{search.error.message}}</p>
                <p ng-bind-html="search.error.body"></p>
            </div>
            <div ng-if="search.queryRunning">
                <p class="lead">Searching <span ng-init="query = search.queryRunning; querystringRunning = search.querystringRunning" ng-include="'search/search-query.html'"></span></p>
                <p>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:100%;">
                            <span class="sr-only">In Progress</span>
                        </div>
                    </div>
                </p>
            </div>

            <div ng-if="!search.queryRunning">
                <!-- search results summary -->
                <div class="clearfix">
                    <div class="pull-left">
                        <span ng-if="! search.results.hits.total > 0">No results</span>
                        <span ng-if="search.results.hits.total > 0 && search.query._query_string">
                            {{
                                search.query.body.from + 1                               | number
                            }}-{{
                                search.query.body.from + search.results.hits.hits.length | number
                            }} of {{search.results.hits.total | number}} results
                        </span>
                        <span ng-init="query = search.query" ng-if="search.query._query_string" ng-include="'search/search-query.html'"></span>
                    </div>
                    <div ng-if="search.query._query_string" class="pull-right">
                        <span style="vertical-align: middle;">
                            <i class='fa fa-folder-open-o'></i>
                        </span>
                          <select class="selectpicker" query-dossier-picker multiple data-live-search="true"
                                data-style="btn-default btn-sm" for="search"
                                query-string="search.query._query_string" title="Bookmark this query...">
                          </select>
                    </div>
                    <script type="text/ng-template" id="search/search-query.html">
                        for <i class='fa fa-search'></i>
                        <span>
                            [ <strong>{{ (query._query_string || querystringRunning) || 'everything' }}</strong> ]
                        </span>
                        <span ng-if="query._source_query_string">
                            from <em>{{query._source_type}}</em>
                            matching
                            [ <strong>{{query._source_query_string}}</strong> ]
                        </span>
                    </script>
                </div>
                <!--<br>-->
                <!--
                <div ng-if="!search.query._query_string" class="jumbotron" style="padding-top:20px">
                    <h1>{{search.results.hits.total | number}}</h1>
                    <p>documents</p>
                    <h3 style="">Suspicious Entities</h3>
                    <br>
                    <scores-table />
                </div>-->

                <div ng-if="!search.query._query_string" style="padding-top:0px;">
                    <div style="float:right">
                       {{search.results.hits.total | number}} documents
                    </div>
                    <h3 style="padding-top:0px;margin-top:0px">Suspicious Entities</h3>
                    <br>
                      Two metrics summarize extracted flags and structure, and surface the most suspicious entities.
                      <ul>
                      <li><em>bad ass:</em> signals moving of lots of product.
                      <li><em>dumb ass:</em> signals lots of overt selectors and traceability.
                      </ul>
                      For bad ass the scoring takes into account flags Foreign Providers, Traveling, Massage Parlor, 
                      URL Embedding, Multiple Girls, Hotel, Agency, Accepts Credit Cards, Porn / Cam Services, LE Cautious, New to Biz, as well as Movement based on normalized locations. For dumb ass the scoring takes into account flags Juvenile, Risky Services, Bad Experience, Derogatory Descriptions, Fake Photo, Poor English, Coercion, Physical Abuse, Theft / Robbery, Incompletion, Drug Use, and Armed &amp; Dangerous.
                      <br>
                      All scores range from 1 (most suspicious) to 0 (least suspicious). Click headers to sort.<br>
                    <scores-table />
                </div>

                <!-- individual search results -->
                <!-- <ol start="{{search.query.body.from + 1}}"> -->
                    <div ng-repeat="hit in search.results.hits.hits track by $index" class="hit">
                        <!-- provenance hyperlink -->
                        <p class='hide'>
                            <!-- TODO routing param -->
                            <span ng-href="#/view/{{hit._index | urlEncode
                                    }}/{{hit._type | urlEncode
                                    }}?{{hit.parent ? 'parent=' + (hit.parent._id | urlEncode) + '&' : ''
                                    }}id={{hit._id | urlEncode
                                    }}"
                               class="text-muted">{{hit._id}}</span>
                        </p>

                        <!-- highlights, visualization -->

                            <!-- highlight to hint why this is a result -->
                            <blockquote class="small" ng-repeat="(field, highlight) in hit.highlight">
                                <strong class="text-muted">{{field}}:</strong>
                                <span ng-repeat="h in highlight track by $index">
                                    <span ng-if="$index > 0">...</span>
                                    <span ng-bind-html="h"></span>
                                </span>
                            </blockquote>

                            <!-- use custom per-type presentation templates -->
                            <p deepdive-visualized-data="hit" search-result="hit"></p>

                            <!-- raw data -->
                            <!-- <p show-raw-data="hit"></p> -->

                    </div>
                <!-- </ol> -->
            </div>

            <!-- debug info in a modal -->
            <script type="text/ng-template" id="search/search-debug-modal.html">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="searchDebugModalLabel">Search Debug Info</h4>
                </div>
                <div class="modal-body">

                    <h3>query</h3>
                    <div show-raw-data="search.query" level="4"></div>

                    <h3>results</h3>
                    <div show-raw-data="search.results" level="3"></div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" ng-click="$dismiss()">Close</button>
                </div>
            </script>
        </div>
    </div>
</div>

<nav class="navbar navbar-default navbar-fixed-bottom container-fluid clearfix">
    <div class="pull-left" style="margin: 5px 0;">
        <span style="font-size:20px; vertical-align: middle;">
            <i class='fa fa-folder-open-o'></i>
        </span>
        <select class="selectpicker" global-dossier-picker data-live-search="true"
            for="search" title="Select Bookmark Folder...">
        </select>

        <span class="fa-stack fa-sm" style="vertical-align: middle; margin-left:20px;">
            <i class='fa fa-file-o fa-stack-2x'></i>
            <i class='fa fa-search fa-stack-1x'></i>
        </span>
        <select class="selectpicker" dossier-query-picker data-live-search="true"
            for="search" title="Select Query or Doc...">
        </select>
        <button class="btn btn-default" ng-click="search.doNavigateActiveDossier()"
         uib-tooltip="Show all documents from all queries in folder '{{search.active_dossier}}'." tooltip-placement="top"
         ng-disabled="!search.active_dossier">
         Show all</button>
    </div>
    <div class="pull-right" ng-if="search.query._query_string" style="margin-right:50px">
        <pagination class="pagination-sm fa"
        total-items="search.results ? search.results.hits.total
                                    : search.params.p * search.params.n"
                                        items-per-page="search.params.n"
        ng-model="search.params.p"
        ng-model-options="{ debounce: 200 }"
        ng-change="search.doSearch(true)"
        previous-text="&#xf04a;" next-text="&#xf04e;" first-text="&#xf049;" last-text="&#xf050;"
        max-size="9" boundary-links="true"></pagination>
    </div>
</nav>

<link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
<!-- <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'> -->

<style>
body, .VS-interface, .VS-search .dialog, .VS-search input {
    font-family: Lato !important;
}
.sidebar {
    top: 70px;
    bottom: 50px;
    overflow-y: auto;
}
.sidebar h4, .sidebar a {
    word-break: break-all;
    word-wrap: break-word;
    overflow-wrap: break-word;
}
.sidebar h4, .sidebar tr {
    cursor: pointer;
}
blockquote {
    font-size: normal !important;
}
.hit .hlt1 { background-color: #ffc; }
.hit .hlt2 { background-color: #cff; }
.hit .hlt3 { background-color: #fcf; }
.hit .hlt4 { background-color: #ccf; }
.hit .hlt5 { background-color: #cfc; }
.hit .hlt6 { background-color: #fcc; }

.pagination {
    margin: 5px auto;
}
.navbar.navbar-fixed-bottom {
    min-height: auto;
}
.panel-heading .breadcrumb {
    margin-bottom: auto;
    padding: 5px;
}

.hover-show {
    visibility: hidden;
}

.hover-show-wrapper:hover .hover-show {
    visibility: inherit;
}

.VS-search .search_input input {
    box-sizing: initial;
}

h4.ter-juicy-header {
    font-size: 14px;
}

div.ter-juicy-review {
    color: gray;
}

[ng-hide=showJsonTree] {
    font-size: 13px;
    font-family: monospace;
}

.bootstrap-select.btn-group.show-tick .dropdown-menu li a span.create-mark {
    position: absolute;
    display: inline-block;
    right: 15px;
    margin-top: 5px;
    color: orange;
}

body { padding-bottom: 70px; }

</style>

<script type="text/javascript" charset="utf-8">

$.fn.bootstrapDP = $.fn.datepicker.noConflict();

window.setupMySelectPicker = function($elem, options, change_callback) {
    $elem.empty()
    $elem.off('change.dossier_callback');
    var all_values = {};
    var old_values = [];
    _.each(options, function(option) {
        $elem.append($('<option/>', {
            value: option.name,
            text: option.name
        }).prop('selected', option.selected));
        all_values[option.name] = true;
        if (option.selected) {
            old_values.push(option.name);
        }
    });
    var picker = $elem.selectpicker('refresh').data('selectpicker');
    var $dropdown = picker.$newElement.find('ul.dropdown-menu');
    var $new_item = $('<li class="hidden"><a><span class="text"></span>' +
        '<span class="glyphicon glyphicon-plus create-mark"></span></a></li>');
    $dropdown.prepend($new_item);
    picker.$newElement.find('button').attr('title',
        'Select existing bookmark folder(s) or create a new one. Folders are shared by all users.').tooltip()
    var $sbox = picker.$searchbox;
    $sbox.attr('placeholder', 'Search or create');
    $sbox.on('input propertychange', function() {
        var val = $.trim($sbox.val());
        if (val && !all_values[val]) {
            $new_item.find('span.text').text(val);
            $new_item.removeClass('hidden');
        } else {
            $new_item.addClass('hidden');
        }
    });
    $new_item.on('click', function(){
        var val = $new_item.find('span.text').text();
        if (!val || all_values[val]) return;
        all_values[val] = true;
        $new_item.detach();
        $elem.prepend($('<option/>', {
            value: val,
            text: val
        }).prop('selected', true));
        picker.$newElement.removeClass('open');
        picker.refresh();
        $dropdown.prepend($new_item);
    });
    $elem.on('change.dossier_callback', function(){
        var vals = picker.val() || [];
        change_callback(old_values, vals);
        old_values = vals;
    });
};

$(function(){

    $('body').on('click', '.facet-header', function(){
        $(this).find('i').toggleClass('fa-plus-square-o').toggleClass('fa-minus-square-o')
    });

    $('body').on('click', '.minmax-go', function(evt){
        var $p = $(this).parent().parent();
        var min = $.trim($p.find('.min-box').val()).replace("'", '"'),
            max = $.trim($p.find('.max-box').val()).replace("'", '"'),
            field = $p.data('field');
        if (!min && !max) return;
        if (!/^[a-zA-Z0-9-_]*$/.test(min)) {
            min = '"' + min.replace(/"/g, '\\"') + '"';
        }
        if (!/^[a-zA-Z0-9-_]*$/.test(max)) {
            max = '"' + max.replace(/"/g, '\\"') + '"';
        }
        var val = '[' + (min || '*') + ' TO ' + (max || '*') + ']';
        if (val.indexOf('"') >= 0) {
            val = "'" + val + "'";
        }
        window.visualSearch.SEARCH.doNavigate(evt, field, val);
    });

    function setupSearchBar() {
        var SEARCH = angular.element($('.navbar-fixed-top').find('[for=search]')[0]).scope().search;
        var ELASTIC = SEARCH.elastic;
        var searchable = SEARCH.getFieldsFor('searchable');
        var navigable = SEARCH.getFieldsFor('navigable');
        // Categories would break VS as it's not compatible with JqUI 1.11.4
        // var facets = _.map(searchable, function(x) {
        //     return {
        //         label: x,
        //         category: 'Content Fields'
        //     };
        // }).concat(_.map(navigable, function(x) {
        //     return {
        //         label: x,
        //         category: 'Facet Fields'
        //     };
        // }));
        var facets = searchable.concat(navigable);
        window.visualSearch = VS.init({
          container : $('.visual_search'),
          query     : '',
          callbacks : {
            search       : function(query, searchCollection) {
                SEARCH.params.s = query;
                SEARCH.doSearch();
            },
            facetMatches : function(callback) {
                var views = visualSearch.searchBox.inputViews;
                var view = views[views.length - 1];
                var val = view.value();
                var cur = view.box[0].selectionStart;
                if (cur != val.length) {
                    callback([]);
                } else {
                    var matches = _.filter(facets, function(x) {
                        return x.indexOf(val) === 0;
                    });
                    callback(matches);
                }
            },
            valueMatches : function(facet, searchTerm, callback) {
                if (!_.contains(navigable, facet)) return;
                var request = {
                    index:  '_all',
                    type: SEARCH.params.t,
                };
                var promise;
                if (!searchTerm) {
                    // ES suggest API doesn't return results when query is empty.
                    // We use the aggs API instead in that case.
                    request.body = {
                        aggs: {
                            hist: {
                                terms: {
                                    size: 20,
                                    field: facet
                                }
                            }
                        }
                    };
                    promise = ELASTIC.search(request);
                } else {
                    var comp = {
                        size: 20,
                        field : facet + "__suggest"
                    };
                    if (facet != 'phones') {
                        comp.fuzzy = {
                            prefix_length: 3
                        };
                    }
                    request.body = {
                        suggest: {
                            text: searchTerm,
                            completion: comp
                        }
                    }
                    promise = ELASTIC.suggest(request);
                }
                promise.then(function(data) {
                    var results;
                    if (data.suggest && data.suggest.length) {
                        results = _.map(data.suggest[0].options, function(item) {
                            return {
                                value: item.text,
                                // Although we do set weight=1 when indexing suggest fileds,
                                // the final score is not the sum.
                                label: item.text // + ' (' + item.score + ')'
                            };
                        });
                    } else if (data.aggregations && data.aggregations.hist) {
                        results = _.map(data.aggregations.hist.buckets, function(item) {
                            return {
                                value: item.key,
                                label: item.key + ' (' + item.doc_count + ')'
                            };
                        });
                    } else {
                        return;
                    }

                    callback(results, {
                        preserveMatches: true
                    });
                });
            }
          }
        });
        window.visualSearch.SEARCH = SEARCH;
    }

    function setupSearchBarWhenSchemaJsonIsFetched() {
        var SEARCH = angular.element($('.navbar-fixed-top').find('[for=search]')[0]).scope().search;
        if(!SEARCH || !SEARCH.types) {
            window.setTimeout(setupSearchBarWhenSchemaJsonIsFetched, 100);
        } else {
            setupSearchBar();
        }
    }
    setupSearchBarWhenSchemaJsonIsFetched();

});


</script>
